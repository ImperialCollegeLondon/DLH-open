# Demo Python Custom Notebook Grader for Coursera
This is a basic template for creating an autograder for a notebook lab submission in Coursera. It is a modification of the Coursera-provided *DemoPythonGrader*, which can be found [here](https://github.com/coursera/programming-assignments-demo/tree/master/custom-graders). Instructions on setting up your environment to write and test custom graders locally are available in the readme at the address linked above.

As with DemoPythonGrader, this notebook grader acts as a basic starting point from which to build a more complete grader. For example, this grader provides minimal feedback, doesn't test for specific common mistakes, and doesn't test if the students are handling incorrect inputs to their functions.

In its current form this grader takes a notebook lab submission in Coursera and converts the highlighted graded cells to a `submission` file. The cells are highlighted as graded by the `graded_id` string on their first line, in this case given by `# GRADED FUNCTION:`. This can be changed in `grader.py`. The graded cells contain functions whose outputs are compared to model solutions.

# Grader workflow
At a high-level, this custom grader accomplishes autograding of student submissions following these steps:
1. The Dockerfile creates the image. It sets up a Python 3 environment and installs dependencies. For custom images please include the necessary packages for your user's submissions to run. The Dockerfile then copies over the relevant files for grading, and assigns appropriate permissions. It launches into the `ENTRYPOINT`, which in this grader is defined as `grader.py`.
2. In `grader.py`, the `main` function assigns the number of test cases and number of graded functions to run against the submission & solution.
3. The grader then checks for the student submission notebook output in JSON format in the `/shared/submission/` directory. This is the standard submission directory across all courses on Coursera, and is a read-only directory.
4. In `make_submission.py`, the `make_submission` function converts the notebook output into a `submission` file with the file extension specified in the JSON notebook output.
4. Test cases are randomly generated according to the number of test cases defined in Step 2. Corresponding solutions are also generated using the files in `/autograder/solutions/`.
5. The grader then runs the test cases through the learner submission.
6. After comparing the learner submission outputs to the solutions, the grader calculates the total score and sends back a JSON object with `fractionalScore` and `feedback` fields. On the Coursera platform, this JSON object can be viewed by the learner; however, the learner does not have access to `stderr`. It is important to include appropriate feedback from the custom grader into the `feedback` field of this JSON object.

# File list and descriptions
In this demo the student has submitted two graded codeblocks, with functions `factors1` and `factors2`. In this case the functions perform identically, taking a positive integer and returning a list of the factors of the integer. 

The solution file is `/solutions/solution.py`.
<br><br>
The following files are required to build a grader image:
* `Dockerfile` sets up the Docker image. It includes a Python 3 environment and copies over the relevant files for grading. If your notebook uses any additional packages they will need to be installed using the Dockerfile
* `grader.py` is the main grading file and serves as the `ENTRYPOINT` for the Docker image. Make sure the first line of the grader file points to the location of the programme you wish to execute the command with. For example, `#!/usr/bin/python3` for an image which installs python3 at its default location, or `#!/opt/conda/bin/python3` for an image which builds on a base jupyter notebook image
* `make_submission.py` takes the JSON object submitted by the learner and converts the relevant code, highlighted by `graded_id`,  to a `submission` file, with the file extension specified in the JSON notebook output.
* `testCases.py` generates random positive integers and uses the solution files provided to generate the correct output. `grader.py` then compares these to the output generated by the learner's functions.
* `util.py` contains helper functions that are used in `grader.py`.
* `solutions/` directory contains the solution file which is used to generate correct outputs to the test cases.
* `sample-submissions/nb_output.json` is an example jupyter notebook output.

# Instructions
1. Run the following command to build the Docker image with the tag `autograder`:

        docker build -t autograder autograder/

2. Run the grader locally using [courseraprogramming](https://github.com/coursera/courseraprogramming) and provide the sample submission in the `sample-submissions` folder:

        courseraprogramming grade local autograder sample-submissions

3. If you want, you can also examine the image by running a shell in a container:

        courseraprogramming inspect -d sample-submissions autograder

4. Once you've tried testing locally, it's time to upload the grader to the platform. You can upload the build files or the built Docker image to the Coursera platform. If you're uploading the build files, create a .zip file of all files in the `/autograder` folder.

# Custom Graded Notebooks Creation Guide

This walkthrough begins assuming you have your custom image built in your course shell's lab manager.

The Coursera partner help files for this walkthrough are [here](https://partner.coursera.help/hc/en-us/articles/360037660172-Create-Lab-Activities-with-Coursera-Labs). This walkthrough condenses the steps into a clearer set of instructions.

1. Create your lab in your custom image.  The specific steps are as follows:

    i. Add a lab to your custom image. Make sure to include the mountpoint, which should be `/home/jovyan/work` unless otherwise specified

    ii. Launch the lab and upload the files required for your lab, or create the files in the lab here. It's best practice to have an up to date copy of these files on your local machine or github, as it's easy to remove these files in Coursera.

    iii. Make sure to indicate the graded cells using the `graded_id` in the first line. For example, for this demo the factors1 cell might look like:

        # GRADED FUNCTION: factors1

        def factors1(n):

            ## Write your code here

    iv. Make a note of the path to the notebook you want your learners to load into, save and publish the lab. We'll return to configure the lab shortly.

2. Create your custom grader using this document and its associated files as a base. Some steps you may need to remember to take, depending on how much you wish to modify these files:

    i. Create a file containing the corrects solutions as functions under the `solutions` folder

    ii. Modify the Dockerfile to include all necessary packages

    iii. Modify `testCases.py` to include any special testCases you wish to try on the learner's solutions

    iv. Modify `grader.py` to include more detailed feedback

    v. Create an appropriate sample submission JSON object for testing

3. Create a programming assignment on Coursera and fill out the details

    i. Under `Edit Course`, create a programming assignment, fill out the first few boxes and choose submit via lab

    ii. Under `Lab Submission` select the image and lab. The content path is the path to the notebook in which you want your learner to start
    
    iii. Under `Lab Grading` select `Add Part` and choose a `PART TITLE`. You must also add a `SCHEMA ID`, which is an identifier unique to each lab, using numbers, letters, and dashes only. Keep a note of this.
    
    iv. Select the same mount point as in Lab Manager, by default `/home/jovyan/work`

    v. The `File Path` is the path to the notebook the learners will submit.

    vi. Name the suggested file and include the `.json` file extension, for example `nb_output.json`. This will be the name of the file submitted by the learners and which will be processed by `make_submission`

    vii. Upload your custom notebook grader


4. Configure the notebook to add a submit button.

    i. Return to the lab in the custom image. Inside the notebook you wish the learner to submit, go to `edit > edit notebook metadata` and add the following code inside the first set of curly braces:

        "coursera": {
        "schema_names":  [
            <SCHEMA ID from programming assignment>,
            <another SCHEMA ID from the same programming assignment>
            ]
        },

    Here's an example of a full notebook metadata:

        {
            "coursera": {
                "schema_names": [
                    "schema-1-name"
                ]
            },
            "kernelspec": {
                "name": "python3",
                "display_name": "Python 3",
                "language": "python"
            },
            "language_info": {
            "name": "python",
            "version": "3.7.3",
            "mimetype": "text/x-python",
            "codemirror_mode": {
                "name": "ipython",
                "version": 3
            },
            "pygments_lexer": "ipython3",
            "nbconvert_exporter": "python",
            "file_extension": ".py"
            }
        }
    
    ii. Don't forget to save and publish the lab

5. Publish your programming assignment and view it from leaner view to test that everything works as expected.
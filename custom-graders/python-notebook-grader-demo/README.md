# Python Custom Notebook Grader Demo for Coursera
This is a basic template for creating an autograder for a notebook lab submission in Coursera. It is a modification of the Coursera-provided *DemoPythonGrader*, which can be found [here](https://github.com/coursera/programming-assignments-demo/tree/master/custom-graders). Instructions on setting up your environment to write and test custom graders locally are available in the readme at the address linked above. You will need [docker](https://docs.docker.com/get-started/) and [courseraprogramming](https://github.com/coursera/courseraprogramming) to create your autograder.

Please get in touch with the DLH tech team if you have any further questions regarding building autograders.

As with DemoPythonGrader, this notebook grader acts as a basic starting point from which to build a more complete grader. For example, this grader provides minimal feedback, doesn't test for specific common mistakes, and doesn't test if the students are handling incorrect inputs to their functions.

In its current form this grader takes a notebook lab submission in Coursera and converts the highlighted graded cells to a `submission` file. It compares these to a `solution` file, which can be generated from a model notebook stored in the `model-submission` folder by running `make-submission` with the last line uncommented.

# Grader workflow
At a high-level, this custom grader accomplishes autograding of student submissions following these steps:
1. The Dockerfile creates the image using the `jupyter/datascience-notebook:3b1f4f5e6cc1` docker image as a base. This means it has all of the associated programming packages associated with that image. For custom images please include the necessary packages for your user's submissions to run. The Dockerfile then copies over the relevant files for grading, and assigns appropriate permissions. When the image is run, it launches into the `ENTRYPOINT`, which in this grader is defined as `grader.py`.
2. In `grader.py`, the `main` function assigns the number of test cases and number of graded functions to run against the submission & solution.
3. The grader then checks for the student submission notebook output with the `.json` or `.ipynb` extension in the `/shared/submission/` directory. This is the standard submission directory across all courses on Coursera, and is a read-only directory.
4. In `make_submission.py`, the `make_submission` function converts the notebook output into a `submission` file with the file extension specified in the JSON notebook output.
4. Test cases are randomly generated according to the number of test cases defined in Step 2. Corresponding solutions are also generated using the files in `/autograder/solutions/`.
5. The grader then runs the test cases through the learner submission.
6. After comparing the learner submission outputs to the solutions, the grader calculates the total score and sends back a JSON object with `fractionalScore` and `feedback` fields. On the Coursera platform, this JSON object can be viewed by the learner; however, the learner does not have access to `stderr`. It is important to include appropriate feedback from the custom grader into the `feedback` field of this JSON object.

# Files included in this demo
In this demo the the student has been tasked with filling out two graded codeblocks, with functions `factors` and `rotation_matrix`. A model version of the completed notebook is featured at `model-submission/graded-notebook-demo-model.ipynb`.

The following files are required to build a grader image:
* `Dockerfile` sets up the Docker image. It includes a Python 3 environment and copies over the relevant files for grading. If your notebook uses any additional packages they will need to be installed using the Dockerfile.
* `grader.py` is the main grading file and serves as the `ENTRYPOINT` for the Docker image. Make sure the first line of the grader file points to the location of the programme you wish to execute the command with. For example, `#!/usr/bin/python3` for an image which installs python3 at its default location, or `#!/opt/conda/bin/python3` for an image which builds on a base jupyter notebook image
* `make_submission.py` takes the notebook submitted by the learner and converts the relevant code, highlighted by `graded_id` and `package_id`,  to a `submission` file, with the file extension specified in the notebook output.
* `testCases.py` generates random tests and uses the solution file to generate the correct output. `grader.py` then compares these to the output generated by the learner's functions.
* `util.py` contains helper functions that are used in `grader.py`.
* `solutions/` directory contains the solution file which is used to generate correct outputs to the test cases.
* `sample-submissions/graded-notebook-demo.ipynb` is an example jupyter notebook output.
* A `readonly` folder containing a copy of `helper_function.py` is included in the `model-submission`, `submissions` and `solutions` folders. A function from this file is imported to one of the graded cells - if your notebook does this please include the appropriate file in the `submissions` and `solutions` folder, so the Dockerfile includes it in the image appropriately.`


# Docker: building and running the grader image
1. Run the following command to build the Docker image with the tag `autograder`:

        docker build -t <autograder-name> autograder/

2. Run the grader locally using [courseraprogramming](https://github.com/coursera/courseraprogramming) and provide the sample submission in the `sample-submissions` folder:

        courseraprogramming grade local <autograder-name> sample-submissions

3. If you want, you can also examine the image by running a shell in a container:

        courseraprogramming inspect -d sample-submissions <autograder-name>

4. Once you've tried testing locally, it's time to upload the grader to the platform. You can upload the build files or the built Docker image to the Coursera platform. If you're uploading the build files, create a .zip file of all files in the `/autograder` folder.

# Customising the autograder

The basic steps of customising the autograder for your grader's assignment are as follows.

1. Write your notebook

    i. Make a model version with the correct answers already included. An example is featured in `model-submission/graded-notebook-demo-model.ipynb`.

    ii. Highlight cells which import packages with the `package_id` on the first line. By default this is `# PACKAGE`

    iii. Highlight cells which are to be graded with the `graded_id` on the first line. By default this is `# GRADED`

    iv. Highlight regions of the code which you will remove for the learner, and where they will write their solutions

    v. Save a copy of the notebook under the `model-submission` folder, and remove the demo notebook

2. Generate a solutions file

    i. Uncomment the last line of `make_submission.py` so that the function `generate_solution()` will run. Then run

        python autograder/make_submission.py

    in the command line.

    ii. Check the `solutions` file looks as you expect it to, and add any read-only files as appropriate in the `solutions` folder. Then comment out `generate_solution()` in `make_submission.py`

3. Create a sample submission for testing

    Using the model notebook, create a sample learner submission under the `sample-submissions` folder.

4. Add any necessary packages to the `Dockerfile`. Doing this first allows you to test the grader as you make changes.

5. Modify the grader

    i. Modify `testCases.py` to import the correct solutions functions, and choose the test cases you wish to try on the student's function. The `testCases` dictionary stores the test cases and the correct answers, given by your model solutions.

    ii. In `grader.py`, change `numTestCases` to the number of test cases used for each function. You may need to modify this if you use a different number for each function. Set `numGradedFuncs` equal to the number of functions you use

    iii. The next part to modify in `grader.py` is the `# Run the learner submission` section. Make sure it imports and tests the correct functions from the `submission` file, and uses the correct test cases from the testCases dictionary.

    iv. Customise your feedback. You can test specific common errors, and use `feedback_flags` to put the feedback in the correct place in the output.


# Adding custom graded notebooks to Coursera

This walkthrough begins assuming you have your custom image built in your course shell's lab manager.

The Coursera partner help files for this walkthrough are [here](https://partner.coursera.help/hc/en-us/articles/360037660172-Create-Lab-Activities-with-Coursera-Labs). This walkthrough condenses the steps into a clearer set of instructions.

1. Create your lab in your custom image.

    i. Add a lab to your custom image. Make sure to include the mountpoint, which should be `/home/jovyan/work` unless otherwise specified

    ii. Launch the lab and upload the files required for your lab, or create the files in the lab here. It's best practice to have an up to date copy of these files on your local machine or github, as it's easy to remove these files in Coursera.

    iii. Make a note of the path to the notebook you want your learners to load into, save and publish the lab. We'll return to configure the lab shortly.

2. Create your custom grader using this document and its associated files as a base.

3. Create a programming assignment on Coursera and fill out the details

    i. Under `Edit Course`, create a programming assignment, fill out the first few boxes and choose submit via lab

    ii. Under `Lab Submission` select the image and lab. The content path is the path to the notebook in which you want your learner to start
    
    iii. Under `Lab Grading` select `Add Part` and choose a `PART TITLE`. You must also add a `SCHEMA ID`, which is an identifier unique to each lab, using numbers, letters, and dashes only. Keep a note of this.
    
    iv. Select the same mount point as in Lab Manager, by default `/home/jovyan/work`

    v. The `File Path` is the path inside the container to the notebook the learners will submit. In our custom labs the notebooks are typically stored under the work folder, so the name of the notebook will suffice. If the notebook is under a directory you have added, you will need to include this information here.

    vi. Name the suggested output file and include the `.json` or `.ipynb` file extension. This will be the name of the file submitted by the learners and which will be processed by `make_submission`

    vii. Upload your custom notebook grader. You can upload the build files or the built Docker image to the Coursera platform. If you're uploading the build files, create a .zip file of all files in the `/autograder` folder.

4. Configure the notebook to add a submit button.

    i. Return to the lab in the custom image. Inside the notebook you wish the learner to submit, go to `edit > edit notebook metadata` and add the following code inside the first set of curly braces:

        "coursera": {
        "schema_names":  [
            <SCHEMA ID from programming assignment>,
            <another SCHEMA ID from the same programming assignment>
            ]
        },

    Here's an example of a full notebook metadata:

        {
            "coursera": {
                "schema_names": [
                    "schema-1-name"
                ]
            },
            "kernelspec": {
                "name": "python3",
                "display_name": "Python 3",
                "language": "python"
            },
            "language_info": {
            "name": "python",
            "version": "3.7.3",
            "mimetype": "text/x-python",
            "codemirror_mode": {
                "name": "ipython",
                "version": 3
            },
            "pygments_lexer": "ipython3",
            "nbconvert_exporter": "python",
            "file_extension": ".py"
            }
        }

5. Publish your programming assignment and view it from leaner view to test that everything works as expected.
